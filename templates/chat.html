{% extends "base.html" %}

{% block title %}–ß–∞—Ç —Å –ö–æ—Å–º–æ–∫–æ—Ç–æ–º{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-header">
        <a href="{{ url_for('platform') }}" class="back-button">
            ‚Üê –ö —á–∞—Ç–∞–º
        </a>
        
        <div class="chat-info">
            <div class="chat-avatar">
                {% if chat_info and chat_info.icon %}
                    <img src="data:image/png;base64,{{ chat_info.icon }}" alt="{{ chat_info.title }}">
                {% else %}
                    <img src="{{ url_for('chat_avatar', chat_id=chat_id) }}" alt="–ê–≤–∞—Ç–∞—Ä —á–∞—Ç–∞" onerror="this.style.display='none'">
                    <span class="avatar-fallback">üê±</span>
                {% endif %}
            </div>
            <div class="chat-details">
                <div class="chat-title">{{ chat_info.title if chat_info else "–ß–∞—Ç —Å –ö–æ—Å–º–æ–∫–æ—Ç–æ–º" }}</div>
                <div class="chat-status">
                    <span class="status-dot"></span>
                    –ö–æ—Å–º–æ–∫–æ—Ç –æ–Ω–ª–∞–π–Ω
                </div>
            </div>
        </div>

        <div class="chat-actions">
            <form method="POST" action="{{ url_for('new_chat') }}" style="display: inline;">
                <button type="submit" class="btn btn-outline btn-small">
                    + –ù–æ–≤—ã–π —á–∞—Ç
                </button>
            </form>
        </div>
    </div>

    <div class="chat-container">
    
    <div class="chat-messages" id="chat-history">
        {% for message in history %}
            <div class="message {% if message.role == 'user' %}user-message{% else %}assistant-message{% endif %}">
                <div class="message-avatar">
                    {% if message.role == 'user' %}üë§{% else %}üê±{% endif %}
                </div>
                <div class="message-content">
                    <div class="message-text">{{ message.content }}</div>
                    <div class="message-time">{{ loop.index }} —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
                </div>
            </div>
        {% endfor %}
        
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π -->
        <div id="new-messages-container"></div>
        
        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏ -->
        <div class="typing-indicator hidden" id="typing-indicator">
            <div class="message assistant-message">
                <div class="message-avatar">üê±</div>
                <div class="message-content">
                    <div class="message-text typing-text">
                        <span class="typing-dots">
                            <span>.</span><span>.</span><span>.</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form class="chat-input-form" id="chat-form">
        <div class="input-container">
            <input type="text" 
                   name="message" 
                   placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ö–æ—Å–º–æ–∫–æ—Ç—É..."
                   class="message-input"
                   id="message-input"
                   required
                   autocomplete="off">
            <button type="submit" class="send-button" id="send-button">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                </svg>
            </button>
        </div>
    </form>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const chatHistory = document.getElementById('chat-history');
    const newMessagesContainer = document.getElementById('new-messages-container');
    const typingIndicator = document.getElementById('typing-indicator');
    const sendButton = document.getElementById('send-button');
    
    let currentChatId = "{{ chat_id }}";
    
    // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
    scrollToBottom();
    
    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const message = messageInput.value.trim();
        if (!message) return;
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –∏ –±–ª–æ–∫–∏—Ä—É–µ–º
        messageInput.value = '';
        messageInput.disabled = true;
        sendButton.disabled = true;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
        addMessageToChat('user', message);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
        showTypingIndicator();
        
        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
            const response = await fetch('/api/send_message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    chat_id: currentChatId,
                    message: message
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
            hideTypingIndicator();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –ò–ò
            if (data.reply) {
                addMessageToChat('assistant', data.reply);
            } else {
                addMessageToChat('assistant', '–ú—è—É? –ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫... üòø');
            }
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            hideTypingIndicator();
            addMessageToChat('assistant', '–ú—è—É! –ü—Ä–æ–±–ª–µ–º—ã —Å –∫–æ—Å–º–∏—á–µ—Å–∫–æ–π —Å–≤—è–∑—å—é... üõ∞Ô∏è');
        } finally {
            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.focus();
        }
    });
    
    function addMessageToChat(role, content) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}-message new-message`;
        
        const avatar = role === 'user' ? 'üë§' : 'üê±';
        const time = new Date().toLocaleTimeString('ru-RU', {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        messageDiv.innerHTML = `
            <div class="message-avatar">${avatar}</div>
            <div class="message-content">
                <div class="message-text">${content}</div>
                <div class="message-time">${time}</div>
            </div>
        `;
        
        newMessagesContainer.appendChild(messageDiv);
        scrollToBottom();
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
        setTimeout(() => {
            messageDiv.style.opacity = '1';
            messageDiv.style.transform = 'translateY(0)';
        }, 10);
    }
    
    function showTypingIndicator() {
        typingIndicator.classList.remove('hidden');
        scrollToBottom();
    }
    
    function hideTypingIndicator() {
        typingIndicator.classList.add('hidden');
    }
    
    function scrollToBottom() {
        setTimeout(() => {
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }, 100);
    }
    
    // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    messageInput.focus();
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            chatForm.dispatchEvent(new Event('submit'));
        }
    });
});
</script>
{% endblock %}